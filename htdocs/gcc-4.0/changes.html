<html>

<head>
<title>GCC 4.0 Release Series &mdash; Changes, New Features, and Fixes</title>
</head>

<!-- GCC maintainers, please do not hesitate to update/contribute entries
     concerning those part of GCC you maintain!  2002-03-23, Gerald.
-->

<body>
<h1>GCC 4.0 Release Series<br />Changes, New Features, and Fixes</h1>

<h2>Caveats</h2>

  <ul>
    <li>GCC now generates location lists by default when compiling with debug
	info and optimization.
	<ul>
	  <li>GDB 6.0 and older crashes when it sees location lists.
	      GDB 6.1 or later is needed to debug binaries containing location
	      lists.</li>
	  <li>When you are trying to view a value of a variable in a part of
	      a function where it has no location (for example when the variable
	      is no longer used and thus its location was used for something
	      else) GDB will say that it is not available.</li>
	</ul>
	You can disable generating location lists by
	<code>-fno-var-tracking</code>.</li>
    <li>GCC no longer accepts the <code>-fwritable-strings</code>
        option.  Use named character arrays when you need a writable
        string.</li>
    <li>The options <code>-freduce-all-givs</code> and
        <code>-fmove-all-movables</code> have been discontinued.  They
        were used to circumvent a shortcoming in the heuristics of the
        old loop optimization code with respect to common Fortran constructs.
        The new (tree) loop optimizer works differently and doesn't need those
        work-arounds.</li>
    <li><code>-I-</code> has been deprecated.  <code>-iquote</code> is meant
    to replace the need for this option.</li>
    <li>The MIPS <code>-membedded-pic</code> and <code>-mrnames</code>
        options have been removed.</li>
    <li>All MIPS targets now require the GNU assembler.  In particular,
        IRIX configurations can no longer use the MIPSpro assemblers,
        although they do still support the MIPSpro linkers.</li>
    <li>The SPARC option <code>-mflat</code> has been removed.</li>
    <li>English-language diagnostic messages will now use Unicode
	quotation marks in UTF-8 locales.  (Non-English messages
	already used the quotes appropriate for the language in
	previous releases.)  If your terminal does not support UTF-8
	but you are using a UTF-8 locale (such locales are the default
	on many GNU/Linux systems) then you should set
	<code>LC_CTYPE=C</code> in the environment to disable that
	locale.  Programs that parse diagnostics and expect plain
	ASCII English-language messages should set
	<code>LC_ALL=C</code>.  See <a
	href="http://www.cl.cam.ac.uk/~mgk25/ucs/quotes.html">Markus
	Kuhn's explanation of Unicode quotation marks</a> for more
	information.</li>
  </ul>

<h2>General Optimizer Improvements</h2>

  <ul>
    <li>
        The <a href="../projects/tree-ssa/">tree ssa</a>
        branch has been merged.  This merge has brought in a completely
        new optimization framework based on a higher level intermediate
        representation than the existing RTL representation.  Numerous
        new code transformations based on the new framework are available
        in GCC 4.0, including:<br />

        <ul>
          <li>Scalar replacement of aggregates</li>
          <li>Constant propagation</li>
          <li>Value range propagation</li>
          <li>Partial redundancy elimination</li>
          <li>Load and store motion</li>
          <li>Strength reduction</li>
          <li>Dead store elimination</li>
          <li>Dead and unreachable code elimination</li>
          <li>Autovectorization</li>
          <li>Loop interchange</li>
          <li>Tail recursion by accumulation</li>
        </ul><br />

        Many of these passes outperform their counterparts from previous
        GCC releases.
    </li>
  </ul>

<h2>New Languages and Language specific improvements</h2>

<h3>C family</h3>

  <ul>
    <li>The <code>sentinel</code> attribute has been added to GCC.
        This function attribute allows GCC to warn when variadic
        functions such as <code>execl</code> are not <code>NULL</code>
        terminated.  See the GCC manual for a complete description of
        its behavior.</li>
  </ul>

<h3>C and Objective-C</h3>

  <ul>
    <li>The <code>-Wstrict-aliasing=2</code> option has been added.  This
        warning catches all unsafe cases, but it may also give a warning for
        some cases that are safe.</li>
    <li>The cast-as-lvalue, conditional-expression-as-lvalue and
        compound-expression-as-lvalue extensions, which were
        deprecated in 3.3.4 and 3.4, have been removed.</li>
    <li>The <code>-fwritable-strings</code> option, which was
        deprecated in 3.4, has been removed.</li>
    <li><code>#pragma pack()</code> semantics have been brought closer to
        those used by other compilers. This also applies to C++.</li>
    <li>Taking the address of a variable with <code>register</code>
        storage is invalid in C.  GCC now issues an error instead of a
        warning.</li>
  </ul>

<h3>C++</h3>

  <ul>
    <li>When compiling without optimizations (<code>-O0</code>), the C++
        frontend is <em>much</em> faster than in any previous
        versions of GCC. Independent testers have measured speed-ups up to
        25% in real-world production code, compared to the 3.4 family (which
        was already the fastest version to date). Upgrading from older
        versions might show even bigger improvements.</li>
    <li>ELF visibility attributes can now be applied to a class type,
        so that it affects every member function of a class at once,
        without having to specify each individually:
        <pre>class __attribute__ ((visibility(&quot;hidden&quot;))) Foo
{
   int foo1();
   void foo2();
};</pre>The syntax is deliberately similar to the <code>__declspec()</code>
        system used by Microsoft Windows based compilers, allowing
        cross-platform projects to easily reuse their existing macro system for
        denoting exports and imports. By explicitly marking internal classes
        never used outside a binary as hidden, one can completely avoid PLT
        indirection overheads during their usage by the compiler. You can find
        out more about the advantages of this at <a
        href="http://people.redhat.com/drepper/dsohowto.pdf">
        http://people.redhat.com/drepper/dsohowto.pdf</a></li>

    <li>The <code>-fvisibility-inlines-hidden</code> option has been added
        which marks all inlineable functions as having hidden ELF visibility,
        thus removing their symbol and typeinfo from the exported symbol table
        of the output ELF binary. Using this option can reduce the exported
        symbol count of template-heavy code by up to 40% with no code change
        at all, thus notably improving link and load times for the binary as
        well as a reduction in size of up to 10%. Also, check the new
        <a href="#visibility"><code>-fvisibility</code> option</a>.</li>

    <li>The compiler now uses the library interface specified by the <a
        href="http://www.codesourcery.com/cxx-abi/">C++ ABI</a> for
        thread-safe initialization of function-scope static variables.
        Most users should leave this alone, but embedded programmers may
        want to disable this by specifying
        <code>-fno-threadsafe-statics</code> for a small savings in code
        size.</li>

    <li>Taking the address of an explicit register variable is no
        longer supported.  Note that C++ allows taking the address of
        variables with <code>register</code> storage so this will
        continue to compile with a warning.  For example, assuming
        that <code>r0</code> is a machine register:
        <pre>register int foo asm ("r0");
register int bar;
&amp;foo; // error, no longer accepted
&amp;bar; // OK, with a warning</pre></li>

    <li>G++ has an undocumented extension to virtual function
	covariancy rules that allowed the overrider to return a type
	that was implicitly convertable to the overridden function's
	return type.   For instance a function returning <code>void
	*</code> could be overridden by a function returning
	<code>T *</code>.  This is now deprecated and will be removed in
	a future release.</li>
  </ul>

<h3>Java</h3>

  <ul>
    <li>In order to prevent naming conflicts with other implementations
        of these tools, some GCJ binaries have been renamed:
	<ul>
	  <li><code>rmic</code> is now <code>grmic</code>,</li>
	  <li><code>rmiregistry</code> is now <code>grmiregistry</code>,
              and</li>
	  <li><code>jar</code> is now <code>fastjar</code>.</li>
	</ul>
	In particular, these names were problematic for the jpackage.org
        packaging conventions which install symlinks in <code>/usr/bin</code>
        that point to the preferred versions of these tools.
    </li>

    <li>The <code>-findirect-dispatch</code> argument to the compiler
      now works and generates code following a new "binary
      compatibility" ABI.  Code compiled this way follows the binary
      compatibility rules of the Java Language Specification.
    </li>

    <li>libgcj now has support for using GCJ as a JIT, using
      the <code>gnu.gcj.jit</code> family of system properties.
    </li>

    <li>libgcj can now find a shared library corresponding to the
      bytecode representation of a class.  See the documentation for
      the new <code>gcj-dbtool</code> program, and the
      new <code>gnu.gcj.precompiled.db.path</code> system property.
    </li>

    <li>There have been many improvements to the class library.  Here
      are some highlights:
      <ul>
	<li>Much more of AWT and Swing exist.
	</li>

	<li>Many new packages and classes were added,
	  including <code>java.util.regex</code>, <code>java.net.URI</code>,
	  <code>javax.crypto</code>,
	  <code>javax.crypto.interfaces</code>, <code>javax.crypto.spec</code>,
	  <code>javax.net</code>, <code>javax.net.ssl</code>,
	  <code>javax.security.auth</code>,
	  <code>javax.security.auth.callback</code>,
	  <code>javax.security.auth.login</code>,
	  <code>javax.security.auth.x500</code>,
	  <code>javax.security.sasl</code>,
	  <code>org.ietf.jgss</code>,
	  <code>javax.imageio</code>,
	  <code>javax.imageio.event</code>,
	  <code>javax.imageio.spi</code>,
	  <code>javax.print</code>,
	  <code>javax.print.attribute</code>,
	  <code>javax.print.attribute.standard</code>, and
	  <code>javax.print.event</code>
	</li>
      </ul>
    </li>

  </ul>

<h3>Fortran</h3>

  <ul>
    <li>A new <a href="http://gcc.gnu.org/fortran/">Fortran</a> front end
        has replaced the aging GNU Fortran 77 front end.  The new front end
        supports Fortran 90 and Fortran 95.  It may not yet be as stable as
        the old Fortran front end.
    </li>
  </ul> 

<h2>New Targets and Target Specific Improvements</h2>

<h3>H8/300</h3>
  <ul>
    <li>The frame layout has changed.  In the new layout, the prologue
    of a function first saves registers and then allocate space for
    locals, resulting in an 1% improvement on code size.</li>
  </ul>

<h3>IA-32/x86-64 (AMD64)</h3>
  <ul>
    <li>The <code>acos</code>, <code>asin</code>, <code>drem</code>,
        <code>exp10</code>, <code>exp2</code>, <code>expm1</code>,
        <code>fmod</code>, <code>ilogb</code>, <code>log10</code>,
        <code>log1p</code>, <code>log2</code>, <code>logb</code> and
        <code>tan</code> mathematical builtins (and their float and long
        double variants) are now implemented as inline x87 intrinsics
        when using <code>-ffast-math</code>.</li>

    <li>The <code>ceil</code>, <code>floor</code>, <code>nearbyint</code>,
	<code>rint</code> and <code>trunc</code> mathematical builtins
	(and their float and long double variants) are now implemented as
	inline x87 intrinsics when using <code>-ffast-math</code>.</li>

    <li>The x87's <code>fsincos</code> instruction is now used automatically
        with <code>-ffast-math</code> when calculating both the sin and cos
        of the same argument.</li>

    <li>Instruction selection for multiplication and division by constants
        has been improved.</li>
  </ul>

<h3>IA-64</h3>
  <ul>
    <li>Floating point division, integer division and <code>sqrt</code>
        are now inlined, resulting in significant performance improvements
        on some codes.</li>
  </ul>

<h3>MIPS</h3>
  <ul>
    <li>Division by zero checks now use conditional traps if the target
        processor supports them.  This decreases code size by one word per
        division operation.  The old behavior (branch and break) can
        be obtained either at configure time by passing
        <code>--with-divide=breaks</code> to <code>configure</code> or at
        runtime by passing <code>-mdivide-breaks</code> to GCC.</li>
    <li>Support for MIPS64 paired-single instructions has been added.
        It is enabled by <code>-mpaired-single</code> and can be accessed
        using both the target-independent vector extensions and new
        MIPS-specific built-in functions.</li>
    <li>Support for the MIPS-3D ASE has been added.  It is enabled by
        <code>-mips3d</code> and provides new MIPS-3D-specific
        built-in functions.</li>
    <li>The <code>-mexplicit-relocs</code> option now supports static
        n64 code (as is used, for example, in 64-bit linux kernels).
        <code>-mexplicit-relocs</code> should now be feature-complete
        and is enabled by default when GCC is configured to use a
        compatible assembler.</li>
    <li>Support for the NEC VR4130 series has been added.  This support
        includes the use of VR-specific instructions and a new VR4130
        scheduler.  Full VR4130 support can be selected with
        <code>-march=vr4130</code> while code for any ISA can be tuned
        for the VR4130 using <code>-mtune=vr4130</code>.  There is also
        a new <code>-mvr4130-align</code> option that produces better
        schedules at the cost of increased code size.</li>
    <li>Support for the Broadcom SB-1 has been extended.  There is now
        an SB-1 scheduler as well as support for the SB-1-specific
        paired-single instructions.  Full SB-1 support can be selected with
        <code>-march=sb1</code> while code for any ISA can be optimized
        for the SB-1 using <code>-mtune=sb1</code>.</li>
    <li>The compiler can now work around errata in R4000, R4400 and
        VR4120 processors.  These workarounds are enabled by
        <code>-mfix-r4000</code>, <code>-mfix-r4400</code> and
        <code>-mfix-vr4120</code> respectively.</li>
  </ul>

<h3>SPARC</h3>
  <ul>
    <li>The options <code>-mv8</code>, <code>-msparclite</code>,
        <code>-mcypress</code>, <code>-msupersparc</code>,
        <code>-mf930</code> and <code>-mf934</code> have been removed.
        They have been replaced with <code>-mcpu=xxx</code>.</li>
    <li>The internal model used to estimate the relative cost of each
        instruction has been updated.  It is expected to give better
        results on recent UltraSPARC processors.</li>
    <li>Code generation for function prologues and epilogues has been
        improved, resulting in better scheduling and allowing multiple
        exit points in functions.</li>
    <li>Support for Sun's Visual Instruction Set (VIS) has been enhanced.
	It is enabled by <code>-mvis</code> and provides new built-in functions
	for VIS instructions on UltraSPARC processors.</li>
  </ul>

<h3>NetWare</h3>
  <ul>
    <li>Novell NetWare (on ix86, no other hardware platform was ever
        really supported by this OS) has been re-enabled and the ABI
        supported by GCC has been brought into sync with that of MetroWerks
        CodeWarrior (the ABI previously supported was that of some Unix
        systems, which NetWare never tried to support).</li>
  </ul>

<h2>Documentation improvements</h2>

<h2>Other significant improvements</h2>

  <ul>
    <li>Location lists are now generated by default when compiling with debug
	info and optimization.  Location lists provide more accurate debug info
	about locations of variables and they allow debugging code compiled
	with <code>-fomit-frame-pointer</code>.</li>
	
	<li><a name="visibility">The <code>-fvisibility</code> option</a> has
	been added which allows the default ELF visibility of all symbols to be
	set per compilation and the new <code>#pragma GCC visibility</code>
	preprocessor command allows the setting of default ELF visibility for a
	region of code. Using <code>-fvisibility=hidden</code> especially in
	combination with the new <code>-fvisibility-inlines-hidden</code> can
	yield substantial improvements in output binary quality including
	avoiding PLT indirection overheads, reduction of the exported symbol
	count by up to 60% (with resultant improvements to link and load times),
	better scope for the optimizer to improve code and up to a 20% reduction
	in binary size. Using these options correctly yields a binary with a
	similar symbol count to a Windows DLL.<br/>
	Perhaps more importantly, this new feature finally allows (with careful
	planning) complete avoidance of symbol clashes when manually loading
	shared objects with RTLD_GLOBAL, thus finally solving problems many
	projects such as python were forced to use RTLD_LOCAL for (with its
	resulting issues for C++ correctness). You can find more information about
	using these options at <a
	href="http://www.nedprod.com/programs/gccvisibility.html">
	http://www.nedprod.com/programs/gccvisibility.html</a></li>
  </ul>

</body>
</html>
