<html>

<head>
<title>GCC 4.0 Release Series &mdash; Changes, New Features, and Fixes</title>
</head>

<!-- GCC maintainers, please do not hesitate to update/contribute entries
     concerning those part of GCC you maintain!  2002-03-23, Gerald.
-->

<body>
<h1>GCC 4.0 Release Series<br />Changes, New Features, and Fixes</h1>

<h2>Caveats</h2>

  <ul>
    <li>GCC now generates location lists by default when compiling with debug
	info and optimization.
	<ul>
	  <li>GDB 6.0 and older crashes when it sees location lists.
	      GDB 6.1 or later is needed to debug binaries containing location
	      lists.</li>
	  <li>When you are trying to view a value of a variable in a part of
	      a function where it has no location (for example when the variable
	      is no longer used and thus its location was used for something
	      else) GDB will say that it is not available.</li>
	</ul>
	You can disable generating location lists by
	<code>-fno-var-tracking</code>.</li>
    <li>GCC no longer accepts the <code>-fwritable-strings</code>
        option.  Use named character arrays when you need a writable
        string.</li>
    <li>The options <code>-freduce-all-givs</code> and
        <code>-fmove-all-movables</code> have been discontinued.  They
        were used to circumvent a shortcoming in the heuristics of the
        old loop optimization code with respect to common Fortran constructs.
        The new (tree) loop optimizer works differently and doesn't need those
        work-arounds.</li>
    <li><code>-I-</code> has been deprecated.  <code>-iquote</code> is meant
    to replace the need for this option.</li>
  </ul>

<h2>General Optimizer Improvements</h2>

<h2>New Languages and Language specific improvements</h2>

<h3>C and Objective-C</h3>

  <ul>
    <li>The <code>-Wstrict-aliasing=2</code> option has been added.  This
        warning catches all unsafe cases, but it may also give a warning for
        some cases that are safe.</li>
    <li>The cast-as-lvalue, conditional-expression-as-lvalue and
        compound-expression-as-lvalue extensions, which were
        deprecated in 3.3.4 and 3.4, have been removed.</li>
    <li>The <code>-fwritable-strings</code> option, which was
        deprecated in 3.4, has been removed.</li>
    <li><code>#pragma pack()</code> semantics have been brought closer to
        those used by other compilers. This also applies to C++.</li>
  </ul>

<h3>C++</h3>

  <ul>
    <li>ELF visibility attributes can now be applied to a class type,
        so that it affects every member function of a class at once,
        without having to specify each individually:
        <pre>class __attribute__ ((visibility(&quot;hidden&quot;))) Foo
{
   int foo1();
   void foo2();
};</pre>The syntax is deliberately similar to the <code>__declspec()</code>
        system used by Microsoft Windows based compilers, allowing
        cross-platform projects to easily reuse their existing macro system for
        denoting exports and imports. By explicitly marking internal classes
        never used outside a binary as hidden, one can completely avoid PLT
        indirection overheads during their usage by the compiler. You can find
        out more about the advantages of this at <a
        href="http://people.redhat.com/drepper/dsohowto.pdf">
        http://people.redhat.com/drepper/dsohowto.pdf</a></li>

    <li>The <code>-fvisibility-inlines-hidden</code> option has been added
        which marks all inlineable functions as having hidden ELF visibility,
        thus removing their symbol and typeinfo from the exported symbol table
        of the output ELF binary. Using this option can reduce the exported
        symbol count of template-heavy code by up to 40% with no code change
        at all, thus notably improving link and load times for the binary as
        well as a reduction in size of up to 10%. Also, check the new
        <a href="#visibility"><code>-fvisibility</code> option</a>.</li>

    <li>The compiler now uses the library interface specified by the <a
        href="http://www.codesourcery.com/cxx-abi/">C++ ABI</a> for
        thread-safe initialization of function-scope static variables.
        Most users should leave this alone, but embedded programmers may
        want to disable this by specifying
        <code>-fno-threadsafe-statics</code> for a small savings in code
        size.</li> </ul>

<h3>Java</h3>

  <ul>
    <li>In order to prevent naming conflicts with other implementations
        of these tools, some GCJ binaries have been renamed:
	<ul>
	  <li><code>rmic</code> is now <code>grmic</code>,</li>
	  <li><code>rmiregistry</code> is now <code>grmiregistry</code>,
              and</li>
	  <li><code>jar</code> is now <code>fastjar</code>.</li>
	</ul>
	In particular, these names were problematic for the jpackage.org
        packaging conventions which install symlinks in <code>/usr/bin</code>
        that point to the preferred versions of these tools.
    </li>
  </ul>

<h2>New Targets and Target Specific Improvements</h2>

<h3>H8/300</h3>
  <ul>
    <li>The frame layout has changed.  In the new layout, the prologue
    of a function first saves registers and then allocate space for
    locals, resulting in an 1% improvement on code size.</li>
  </ul>

<h3>IA-32/x86-64 (AMD64)</h3>
  <ul>
    <li>The <code>acos</code>, <code>asin</code>, <code>drem</code>,
        <code>exp10</code>, <code>exp2</code>, <code>expm1</code>,
        <code>fmod</code>, <code>ilogb</code>, <code>log10</code>,
        <code>log1p</code>, <code>log2</code>, <code>logb</code> and
        <code>tan</code> mathematical builtins (and their float and long
        double variants) are now implemented as inline x87 intrinsics
        when using <code>-ffast-math</code>.</li>

    <li>The <code>ceil</code>, <code>floor</code>, <code>nearbyint</code>,
	<code>rint</code> and <code>trunc</code> mathematical builtins
	(and their float and long double variants) are now implemented as
	inline x87 intrinsics when using <code>-ffast-math</code>.</li>

    <li>The x87's <code>fsincos</code> instruction is now used automatically
        with <code>-ffast-math</code> when calculating both the sin and cos
        of the same argument.</li>
  </ul>

<h3>IA-64</h3>
  <ul>
    <li>Floating point division, integer division and <code>sqrt</code>
        are now inlined, resulting in significant performance improvements
        on some codes.</li>
  </ul>

<h3>MIPS</h3>
  <ul>
    <li>Division by zero checks now use conditional traps on platforms
        where it is supported.  This decreases code size by one word per
        division operation.  The old behavior (branch and break) can
        be obtained either at configure time by passing
        <code>--with-divide=breaks</code> to <code>configure</code> or at
        runtime by passing <code>-mdivide-breaks</code> to GCC.</li>
  </ul>

<h3>NetWare</h3>
  <ul>
    <li>Novell NetWare (on ix86, no other hardware platform was ever
        really supported by this OS) has been re-enabled and the ABI
        supported by GCC has been brought into sync with that of MetroWerks
        CodeWarrior (the ABI previously supported was that of some Unix
        systems, which NetWare never tried to support).</li>
  </ul>

<h2>Documentation improvements</h2>

<h2>Other significant improvements</h2>

  <ul>
    <li>Location lists are now generated by default when compiling with debug
	info and optimization.  Location lists provide more accurate debug info
	about locations of variables and they allow debugging code compiled
	with <code>-fomit-frame-pointer</code>.</li>
	
	<li><a name="visibility">The <code>-fvisibility</code> option</a> has
	been added which allows the default ELF visibility of all symbols to be
	set per compilation and the new <code>#pragma GCC visibility</code>
	preprocessor command allows the setting of default ELF visibility for a
	region of code. Using <code>-fvisibility=hidden</code> especially in
	combination with the new <code>-fvisibility-inlines-hidden</code> can
	yield substantial improvements in output binary quality including
	avoiding PLT indirection overheads, reduction of the exported symbol
	count by up to 60% (with resultant improvements to link and load times),
	better scope for the optimizer to improve code and up to a 20% reduction
	in binary size. Using these options correctly yields a binary with a
	similar symbol count to a Windows DLL.<br/>
	Perhaps more importantly, this new feature finally allows (with careful
	planning) complete avoidance of symbol clashes when manually loading
	shared objects with RTLD_GLOBAL, thus finally solving problems many
	projects such as python were forced to use RTLD_LOCAL for (with its
	resulting issues for C++ correctness). You can find more information about
	using these options at <a
	href="http://www.nedprod.com/programs/gccvisibility.html">
	http://www.nedprod.com/programs/gccvisibility.html</a></li>
  </ul>

</body>
</html>
