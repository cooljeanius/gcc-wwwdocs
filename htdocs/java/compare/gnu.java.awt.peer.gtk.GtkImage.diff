--- /home/tromey/gnu/Nightly/classpath/classpath/gnu/java/awt/peer/gtk/GtkImage.java	2003-12-02 02:19:59.000000000 -0700
+++ gnu/java/awt/peer/gtk/GtkImage.java	2003-12-02 02:18:16.000000000 -0700
@@ -60,6 +60,7 @@
   Vector propertyObservers = new Vector ();
 
   ImageProducer source;
+  ImageObserver observer;
   Graphics g;
 
   /* Variables in which we stored cached data, if possible.
@@ -79,9 +80,15 @@
     source = producer;
     this.g = g;
 
-    source.addConsumer (this);
+    if (source != null)
+      source.addConsumer (this);
   }
-  
+
+  public void setObserver (ImageObserver observer)
+  {
+    this.observer = observer;
+  }
+
   public synchronized int 
   getWidth (ImageObserver observer)
   {
@@ -135,8 +142,11 @@
     pixelCache = null;
     model = null;
 
-    source.removeConsumer (this);
-    source.addConsumer (this);
+    if (source != null)
+      {
+	source.removeConsumer (this);
+	source.addConsumer (this);
+      }
   }
 
   public boolean
@@ -168,6 +178,12 @@
 	if (io != null)
 	  io.imageUpdate (this, ImageObserver.HEIGHT, -1, -1, width, height);
       }
+
+    if (observer != null)
+      observer.imageUpdate (this,
+			    (ImageObserver.WIDTH
+			     | ImageObserver.HEIGHT),
+			    -1, -1, width, height);
   }
 
   public synchronized void 
@@ -203,6 +219,11 @@
   {
     setPixels (x, y, width, height, cm, convertPixels (pixels), offset,
 	       scansize);
+
+    if (observer != null)
+      observer.imageUpdate (this,
+			    ImageObserver.SOMEBITS,
+			    x, y, width, height);
   }
 
   public synchronized void 
@@ -244,7 +265,20 @@
     if (status == ImageConsumer.SINGLEFRAMEDONE)
       isCacheable = false;
 
-    source.removeConsumer (this);
+    if (observer != null)
+      {
+	if (status == ImageConsumer.IMAGEERROR)
+	  observer.imageUpdate (null,
+				ImageObserver.ERROR,
+				-1, -1, -1, -1);
+	else
+	  observer.imageUpdate (null,
+				ImageObserver.ALLBITS,
+				-1, -1, -1, -1);
+      }
+
+    if (source != null)
+      source.removeConsumer (this);
   }
 
   public synchronized void
@@ -257,8 +291,11 @@
       }
     else
       {
-	source.startProduction (painter);
-	source.removeConsumer (painter);
+	if (source != null)
+	  {
+	    source.startProduction (painter);
+	    source.removeConsumer (painter);
+	  }
       }
   }
 
