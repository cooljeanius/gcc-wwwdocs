--- /home/tromey/gnu/Nightly/classpath/classpath/java/net/DatagramSocket.java	2003-05-03 02:23:09.000000000 -0600
+++ java/net/DatagramSocket.java	2003-03-23 02:18:02.000000000 -0700
@@ -79,11 +79,6 @@
   DatagramChannel ch;
 
   /**
-   * This is the local address which cannot be changed
-   */
-  private InetAddress local_addr;
-
-  /**
    * This is the address we are "connected" to
    */
   private InetAddress remoteAddress;
@@ -159,34 +154,32 @@
     SecurityManager s = System.getSecurityManager();
     if (s != null)
       s.checkListen(port);
-  
-    // Why is there no factory for this?
-    impl = new PlainDatagramSocketImpl();
+
+    String propVal = System.getProperty("impl.prefix");
+    if (propVal == null || propVal.equals(""))
+      impl = new PlainDatagramSocketImpl();
+    else
+      try
+	{
+          impl = (DatagramSocketImpl) Class.forName
+            ("java.net." + propVal + "DatagramSocketImpl").newInstance();
+	}
+      catch (Exception e)
+	{
+	  System.err.println("Could not instantiate class: java.net." +
+	    propVal + "DatagramSocketImpl");
+	  impl = new PlainDatagramSocketImpl();
+	}
     impl.create();
 
-    if (laddr != null)
-      {
-        try
-          {
-            local_addr = laddr;
-            impl.bind(port, laddr);
-          }
-        catch (SocketException exception)
-          {
-            impl.close();
-            throw exception;
-          }
-        catch (RuntimeException exception)
-          {
-            impl.close();
-            throw exception;
-          }
-        catch (Error error)
-          {
-            impl.close();
-            throw error;
-          }
-      }
+    // For multicasting, set the socket to be reused (Stevens pp. 195-6).
+    if (this instanceof MulticastSocket)
+      impl.setOption(SocketOptions.SO_REUSEADDR, new Boolean(true));
+
+    impl.bind(port, laddr == null ? InetAddress.ANY_IF : laddr);
+    
+    remoteAddress = null;
+    remotePort = -1;
   }
 
   /**
@@ -257,19 +250,38 @@
    */
   public InetAddress getLocalAddress()
   {
-    if (impl == null)
-      return null;
-
-    // FIXME: According to libgcj, checkConnect() is supposed to be called
-    // before performing this operation.  Problems: 1) We don't have the
-    // addr until after we do it, so we do a post check.  2). The docs I
-    // see don't require this in the Socket case, only DatagramSocket, but
-    // we'll assume they mean both.
-    SecurityManager sm = System.getSecurityManager();
-    if (sm != null)
-      sm.checkConnect(local_addr.getHostName(), getLocalPort());
+    // FIXME: JCL p. 510 says this should call checkConnect.  But what
+    // string should be used as the hostname?  Maybe this is just a side
+    // effect of calling InetAddress.getLocalHost.
+    //
+    // And is getOption with SO_BINDADDR the right way to get the address?
+    // Doesn't seem to be since this method doesn't throw a SocketException
+    // and SO_BINADDR can throw one.
+    //
+    // Also see RETURNS section in JCL p. 510 about returning any local
+    // addr "if the current execution context is not allowed to connect to
+    // the network interface that is actually bound to this datagram socket."
+    // How is that done?  via InetAddress.getLocalHost?  But that throws
+    // an UnknownHostException and this method doesn't.
+    //
+    // if (s != null)
+    //   s.checkConnect("localhost", -1);
+    try
+      {
+        return (InetAddress)impl.getOption(SocketOptions.SO_BINDADDR);
+      }
+    catch (SocketException ex)
+      {
+      }
 
-    return local_addr;
+    try
+      {
+        return InetAddress.getLocalHost();
+      }
+    catch (UnknownHostException ex)
+      {
+        return null;
+      }
   }
 
   /**
@@ -279,6 +291,9 @@
    */
   public int getLocalPort()
   {
+    if (!isBound ())
+      return -1;
+
     return impl.getLocalPort();
   }
 
