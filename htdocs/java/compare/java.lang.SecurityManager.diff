--- /home/tromey/gnu/classpath/classpath/java/lang/SecurityManager.java	Wed Mar 20 17:01:40 2002
+++ java/lang/SecurityManager.java	Tue Dec 10 19:20:27 2002
@@ -187,8 +187,7 @@
    */
   protected ClassLoader currentClassLoader()
   {
-    Class c = currentLoadedClass();
-    return c != null ? c.getClassLoader() : null;
+    return VMSecurityManager.currentClassLoader();
   }
 
   /**
@@ -208,8 +207,11 @@
    */
   protected Class currentLoadedClass()
   {
-    int i = classLoaderDepth();
-    return i >= 0 ? getClassContext()[i] : null;
+    Class[] c = getClassContext();
+    for (int i = 0; i < c.length; i++)
+      if (c[i].getClassLoader() != null)
+	return c[i];
+    return null;
   }
 
   /**
@@ -245,18 +247,10 @@
    */
   protected int classLoaderDepth()
   {
-    try
-      {
-        checkPermission(new AllPermission());
-      }
-    catch (SecurityException e)
-      {
-        Class[] c = getClassContext();
-        for (int i = 0; i < c.length; i++)
-          if (c[i].getClassLoader() != null)
-            // XXX Check if c[i] is AccessController, or a system class.
-            return i;
-      }
+    Class[] c = getClassContext();
+    for (int i = 0; i < c.length; i++)
+      if (c[i].getClassLoader() != null)
+	return i;
     return -1;
   }
 
@@ -1022,9 +1016,9 @@
         for (int index = list.indexOf(packageName);
              index != -1; index = list.indexOf(packageName, index + 1))
           {
-            // Exploit package visibility for speed.
-            if (index + packageName.count == list.count
-                || list.charAt(index + packageName.count) == ',')
+	    int packageNameCount = packageName.length();
+            if (index + packageNameCount == list.length()
+                || list.charAt(index + packageNameCount) == ',')
               {
                 checkPermission(p);
                 return;
