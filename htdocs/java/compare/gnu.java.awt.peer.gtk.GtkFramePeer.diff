--- /home/tromey/gnu/Nightly/classpath/classpath/gnu/java/awt/peer/gtk/GtkFramePeer.java	2004-01-14 02:21:29.000000000 -0700
+++ gnu/java/awt/peer/gtk/GtkFramePeer.java	2004-01-20 02:18:19.000000000 -0700
@@ -1,5 +1,5 @@
 /* GtkFramePeer.java -- Implements FramePeer with GTK
-   Copyright (C) 1999, 2002 Free Software Foundation, Inc.
+   Copyright (C) 1999, 2002, 2004 Free Software Foundation, Inc.
 
 This file is part of GNU Classpath.
 
@@ -45,6 +45,7 @@
 import java.awt.Image;
 import java.awt.MenuBar;
 import java.awt.Rectangle;
+import java.awt.Window;
 import java.awt.event.PaintEvent;
 import java.awt.peer.FramePeer;
 import java.awt.peer.MenuBarPeer;
@@ -53,16 +54,41 @@
     implements FramePeer
 {
   int menuBarHeight = 0;
-  native int getMenuBarHeight ();
+  private MenuBarPeer menuBar;
+  native int getMenuBarHeight (MenuBarPeer bar);
 
   native public void setMenuBarPeer (MenuBarPeer bar);
+  native public void removeMenuBarPeer (MenuBarPeer bar);
 
   public void setMenuBar (MenuBar bar)
   {
-    if (bar == null)
-      setMenuBarPeer (null);
-    else
-      setMenuBarPeer ((MenuBarPeer) bar.getPeer ());
+    if (bar == null && menuBar != null)
+    {    
+      removeMenuBarPeer(menuBar); 
+      menuBar = null;
+      insets.top -= menuBarHeight;
+      menuBarHeight = 0;      
+      awtComponent.doLayout();
+    }
+    else if (bar != null)
+    {
+      if (menuBar != null)
+        removeMenuBarPeer(menuBar);
+      menuBar = (MenuBarPeer) ((MenuBar) bar).getPeer();
+      setMenuBarPeer(menuBar);      
+    }
+  }
+
+  protected void postSizeAllocateEvent()
+  {
+    if (menuBar != null)
+    {
+      if (menuBarHeight != 0)
+        insets.top -= menuBarHeight;
+      menuBarHeight = getMenuBarHeight(menuBar);
+      insets.top += menuBarHeight;
+    }
+    awtComponent.doLayout();
   }
 
   public GtkFramePeer (Frame frame)
@@ -74,6 +100,7 @@
   {
     // Create a normal decorated window.
     create (GDK_WINDOW_TYPE_HINT_NORMAL, true);
+    setMenuBar(((Frame) awtComponent).getMenuBar());
   }
 
   public void getArgs (Component component, GtkArgList args)
@@ -102,10 +129,31 @@
     g.translate (-insets.left, -insets.top);
     return g;
   }
-
-  // FIXME: When MenuBars work, override postConfigureEvent and
-  // setBounds to account for MenuBar dimensions.
-
+  
+  protected void postConfigureEvent (int x, int y, int width, int height)
+  {
+    int frame_x = x - insets.left;
+    // Add the height of the menubar (if none, menuBarHeight is 0 and has no
+    // effect). To move the frame down a bit so as to still fit in the window.
+    int frame_y = y - insets.top + menuBarHeight;
+    int frame_width = width + insets.left + insets.right;
+    // Add the height of the menubar to adjust the height so it still fits in
+    // the window.
+    int frame_height = height + insets.top + insets.bottom - menuBarHeight;
+    if (frame_x != awtComponent.getX()
+        || frame_y != awtComponent.getY()
+        || frame_width != awtComponent.getWidth()
+        || frame_height != awtComponent.getHeight())
+      {
+        setBoundsCallback ((Window) awtComponent,
+                           frame_x,
+                           frame_y,
+                           frame_width,
+                           frame_height);
+      }
+    awtComponent.validate();
+  }
+  
   protected void postMouseEvent(int id, long when, int mods, int x, int y, 
 				int clickCount, boolean popupTrigger)
   {
