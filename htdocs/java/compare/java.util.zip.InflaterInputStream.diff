--- /home/tromey/gnu/Nightly/classpath/classpath/java/util/zip/InflaterInputStream.java	2004-10-28 02:27:40.000000000 -0600
+++ java/util/zip/InflaterInputStream.java	2004-10-28 02:16:12.000000000 -0600
@@ -36,12 +36,11 @@
 obligated to do so.  If you do not wish to do so, delete this
 exception statement from your version. */
 
-
 package java.util.zip;
 
 import java.io.FilterInputStream;
-import java.io.IOException;
 import java.io.InputStream;
+import java.io.IOException;
 
 /**
  * This filter stream is used to decompress data compressed in the "deflate"
@@ -71,9 +70,8 @@
    */
   protected int len;
 
-  /*
-   * We just use this if we are decoding one byte at a time with the read() call
-   */
+  // We just use this if we are decoding one byte at a time with the
+  // read() call.
   private byte[] onebytebuffer = new byte[1];
 
   /**
@@ -140,9 +138,8 @@
    */
   public synchronized void close() throws IOException
   {
-    if (in != null)
-      in.close();
-    in = null;
+    inf = null;
+    super.close();
   }
 
   /**
@@ -155,10 +152,8 @@
     
     len = in.read(buf, 0, buf.length);
 
-    if (len < 0)
-      throw new ZipException("Deflated stream ends early.");
-    
-    inf.setInput(buf, 0, len);
+    if (len >= 0)
+      inf.setInput(buf, 0, len);
   }
 
   /**
@@ -168,11 +163,9 @@
    */
   public int read() throws IOException
   { 
-    int nread = read(onebytebuffer, 0, 1); //read one byte
-    
+    int nread = read(onebytebuffer, 0, 1);
     if (nread > 0)
       return onebytebuffer[0] & 0xff;
-    
     return -1;
   }
 
@@ -189,31 +182,35 @@
       throw new IOException("stream closed");
     if (len == 0)
       return 0;
+    if (inf.finished())
+      return -1;
 
     int count = 0;
-    for (;;)
+    while (count == 0)
       {
+	if (inf.needsInput())
+	  fill();
 	
 	try
 	  {
 	    count = inf.inflate(b, off, len);
+	    if (count == 0)
+	      {
+		if (this.len == -1)
+		  {
+		    // Couldn't get any more data to feed to the Inflater
+		    return -1;
+		  }
+		if (inf.needsDictionary())
+		  throw new ZipException("Inflater needs Dictionary");
+	      }
 	  } 
 	catch (DataFormatException dfe) 
 	  {
 	    throw new ZipException(dfe.getMessage());
 	  }
-
-	if (count > 0)
-	  return count;
-	
-	if (inf.needsDictionary()
-	    | inf.finished())
-	  return -1;
-	else if (inf.needsInput())
-	  fill();
-	else
-	  throw new InternalError("Don't know what to do");
       }
+    return count;
   }
 
   /**
