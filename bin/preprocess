#!/bin/sh
#
# This script takes a directory tree containing web pages (i.e., HTML,
# JPEG,... files) and copies it into another tree.
#
# HTML files are processed by means of MetaHTML, binary files are just
# copied and GIF files are warned about.
#
# By Gerald Pfeifer <pfeifer@dbai.tuwien.ac.at> 1999-12-29.

MHC=${MHC-/usr/local/bin/mhc}

SOURCETREE=${SOURCETREE-/www/gcc/htdocs-preformatted}
DESTTREE=${DESTTREE-/www/gcc/htdocs}

STYLE=$SOURCETREE/style.mhtml

####
# Various safety check first. 

if [ ! -d $SOURCETREE ]; then
    echo "Source tree \"$SOURCETREE\" does not exist."
    exit 1
fi

if [ ! -d $DESTTREE ]; then
    echo "Destination tree \"$DESTTREE\" does not exist."
    exit 1
fi

####
# Good guys clean after them.

TMPDIR=/tmp/`basename $0`.$$

cleanup() {
    rm -rf $TMPDIR $1
}

trap "cleanup; exit 1" 0 1 2 15 

####
# Process all files in the source tree, excluding files/directories called CVS.

mkdir $TMPDIR
 
cd $SOURCETREE

for f in `find . \( -name CVS -prune \) -o -type f` ; do

    if [ ! -d "$DESTTREE/`dirname $f`" ]; then
        echo "Creating new directory `dirname $f`."
        mkdir -p $DESTTREE/`dirname $f`
    fi

    case $f in
        */CVS)
            ;;
        *egcs-1.?/*)
            cp $f $DESTTREE/$f
            echo "  Copying $f";
            ;;
        *\.txt|*\.ps|*\.pdf|*\.jpg|*\.jpeg|*\.png|*/fsf-forms/*|*\.patch)
            cp $f $DESTTREE/$f
            echo "  Copying binary $f";
            ;;
        *.html)
            # Prepend the MetaHTML style and process the page.
            cat $STYLE $f > $TMPDIR/input
            ${MHC} $TMPDIR/input > $TMPDIR/output
            # Update the page only if there is a change.
            diff $TMPDIR/output $DESTTREE/$f >/dev/null
            if [ $? -ne 0 ]; then
                echo "  Updating $f"
                cp $TMPDIR/output $DESTTREE/$f
            fi
            ;;
        *\.gif)
            echo "  Warning: GIF file $f ignored."
            ;;
        *)
            echo "  Warning: Unknown type $f; just copied."
            cp $f $DESTTREE/$f      
            ;;
    esac

done
