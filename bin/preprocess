#!/bin/sh
#
# This script takes a directory tree containing web pages (i.e., HTML,
# JPEG,... files) and copies it into another tree or generates a new
# tree.  If filenames are passed on the command-line, only those files
# are processed.
#
# HTML files are processed by means of MetaHTML, binary files are just
# copied, and GIF files are warned about.
#
# By Gerald Pfeifer <pfeifer@dbai.tuwien.ac.at> 1999-12-29.

MHC=${MHC-/usr/local/bin/mhc}

SOURCETREE=${SOURCETREE-/www/gcc/htdocs-preformatted}
DESTTREE=${DESTTREE-/www/gcc/htdocs}

STYLE=$SOURCETREE/style.mhtml

####
# Various safety check first. 

if [ ! -d $SOURCETREE ]; then
    echo "Source tree \"$SOURCETREE\" does not exist."
    exit 1
fi

if [ ! -d $DESTTREE ]; then
    echo "Destination tree \"$DESTTREE\" does not exist."
    exit 1
fi

####
# Exit handler. Good guys clean after them.

TMPDIR=/tmp/`basename $0`.$$

cleanup() {
    rm -rf $TMPDIR $1
}

trap "cleanup; exit 1" 1 2 15 

####
# Remove old cruft from the destination tree.

remove_cruft() {
    cd $DESTTREE

    for f in `find . -type f` ; do
        d=`dirname $f`
        case $d in
            ./onlinedocs*|./benchresults*|./testresults*|./fom_serv*)
                echo "  Warning: Keeping $f";
                ;;
            *)
                if [ ! -f $SOURCETREE/$f ]; then
                    echo "Removing obsolete file $f"
                    #rm $f
                fi
                ;;
        esac
    done

    for d in `find . -type d` ; do
        if [ -z "`ls $d`" ]; then
            echo "Removing obsolete empty directory $d"
            #rmdir $d
        fi
    done
}

####
# Process a single file.

copy_if_different()
{
    s=$1
    d=$2

    if [ ! -f $d ]; then
        echo "  New file $s"
        cp $s $d
    else
        cmp $s $d >/dev/null
        if [ $? -eq 1 ]; then
            echo "  Copying $s";
            cp $s $d
        fi
    fi
}

process_file()
{
    f=$1

    if [ ! -d "$DESTTREE/`dirname $f`" ]; then
        echo "Creating new directory `dirname $f`."
        mkdir -p $DESTTREE/`dirname $f`
    fi

    case $f in
        */CVS|*/\.cvsignore)
            ;;
        *egcs-1.?/*)
            copy_if_different $f $DESTTREE/$f
            ;;
        *\.txt|*\.ps|*\.ps\.gz|*\.pdf|*\.jpg|*\.jpeg|*\.png|*\.patch)
            copy_if_different $f $DESTTREE/$f
            ;;
        *.html)
            # Prepend the MetaHTML style and process the page.
            cat $STYLE $f > $TMPDIR/input
            ${MHC} $TMPDIR/input > $TMPDIR/output

            # Copy the page only if it's new or there has been a change.
            if [ ! -f $DESTTREE/$f ]; then
                echo "  New file $f"
                cp $TMPDIR/output $DESTTREE/$f
            else
                diff $TMPDIR/output $DESTTREE/$f >/dev/null
                if [ $? -ne 0 ]; then
                    echo "  Updating $f"
                    cp $TMPDIR/output $DESTTREE/$f
                fi
            fi
            ;;
        */ChangeLog|*\.gif|*/\.#*)
            echo "  Warning: $f ignored."
            ;;
        *)
            echo "  Warning: Unknown type $f; just copied."
            cp $f $DESTTREE/$f      
            ;;
    esac
}

####
# Process all files in the source tree, excluding files/directories called CVS.

mkdir $TMPDIR
 
cd $SOURCETREE

if [ $# -gt 0 ]; then
    for f in "$@" ; do
        process_file $f
    done
else 
    for f in `find . \( -name CVS -prune \) -o -type f` ; do
        process_file $f
    done
fi

remove_cruft

# Get a clean exit status on success.
cleanup
exit 0
